# Semgrep Configuration for Spring Boot Projects
# This configuration provides security scanning rules for Java/Spring Boot applications

rules:
  # ========================================
  # SQL Injection Prevention
  # ========================================
  - id: sql-injection-jdbctemplate
    pattern: |
      $JDBC.query($SQL + $VAR, ...)
    message: Possible SQL injection. Use parameterized queries instead of string concatenation.
    severity: ERROR
    languages: [java]
    metadata:
      cwe: "CWE-89: SQL Injection"
      owasp: "A03:2021 - Injection"
      category: security

  - id: sql-injection-native-query
    pattern: |
      $EM.createNativeQuery($SQL + $VAR)
    message: Possible SQL injection in native query. Use parameterized queries.
    severity: ERROR
    languages: [java]
    metadata:
      cwe: "CWE-89: SQL Injection"
      owasp: "A03:2021 - Injection"

  # ========================================
  # Command Injection Prevention
  # ========================================
  - id: command-injection
    pattern-either:
      - pattern: Runtime.getRuntime().exec($CMD + $VAR)
      - pattern: ProcessBuilder($CMD + $VAR)
    message: Possible command injection. Avoid concatenating user input in system commands.
    severity: ERROR
    languages: [java]
    metadata:
      cwe: "CWE-78: OS Command Injection"
      owasp: "A03:2021 - Injection"

  # ========================================
  # Path Traversal Prevention
  # ========================================
  - id: path-traversal
    pattern-either:
      - pattern: new File($PATH + $VAR)
      - pattern: Paths.get($PATH + $VAR)
      - pattern: Files.newInputStream(Paths.get($PATH + $VAR))
    message: Possible path traversal vulnerability. Validate and sanitize file paths.
    severity: WARNING
    languages: [java]
    metadata:
      cwe: "CWE-22: Path Traversal"
      owasp: "A01:2021 - Broken Access Control"

  # ========================================
  # Insecure Deserialization
  # ========================================
  - id: unsafe-deserialization
    pattern: |
      $OBJ.readObject(...)
    message: Unsafe deserialization detected. Use safer alternatives or validate input.
    severity: ERROR
    languages: [java]
    metadata:
      cwe: "CWE-502: Deserialization of Untrusted Data"
      owasp: "A08:2021 - Software and Data Integrity Failures"

  # ========================================
  # Weak Cryptography
  # ========================================
  - id: weak-hash-md5
    pattern-either:
      - pattern: MessageDigest.getInstance("MD5")
      - pattern: MessageDigest.getInstance("SHA1")
    message: Weak hash algorithm detected. Use SHA-256 or stronger.
    severity: WARNING
    languages: [java]
    metadata:
      cwe: "CWE-327: Use of a Broken or Risky Cryptographic Algorithm"
      owasp: "A02:2021 - Cryptographic Failures"

  - id: weak-cipher
    pattern-either:
      - pattern: Cipher.getInstance("DES")
      - pattern: Cipher.getInstance("DES/...")
      - pattern: Cipher.getInstance("RC4")
    message: Weak cipher algorithm. Use AES-256 or stronger.
    severity: ERROR
    languages: [java]
    metadata:
      cwe: "CWE-327: Use of a Broken or Risky Cryptographic Algorithm"
      owasp: "A02:2021 - Cryptographic Failures"

  # ========================================
  # Hardcoded Secrets
  # ========================================
  - id: hardcoded-password
    pattern-either:
      - pattern: |
          String $VAR = "password";
      - pattern: |
          String $VAR = "secret";
      - pattern: |
          String $VAR = "api_key";
    message: Possible hardcoded password or secret. Use environment variables or secret management.
    severity: ERROR
    languages: [java]
    metadata:
      cwe: "CWE-798: Use of Hard-coded Credentials"
      owasp: "A07:2021 - Identification and Authentication Failures"

  # ========================================
  # Insecure Random
  # ========================================
  - id: insecure-random
    pattern: new Random()
    message: Insecure random number generator. Use SecureRandom for security-sensitive operations.
    severity: WARNING
    languages: [java]
    metadata:
      cwe: "CWE-330: Use of Insufficiently Random Values"
      owasp: "A02:2021 - Cryptographic Failures"

  # ========================================
  # XXE (XML External Entity) Prevention
  # ========================================
  - id: xxe-vulnerability
    pattern: |
      DocumentBuilderFactory.newInstance()
    message: Potential XXE vulnerability. Disable external entity processing.
    severity: WARNING
    languages: [java]
    metadata:
      cwe: "CWE-611: Improper Restriction of XML External Entity Reference"
      owasp: "A05:2021 - Security Misconfiguration"

  # ========================================
  # CSRF Protection
  # ========================================
  - id: csrf-disabled
    pattern: |
      .csrf().disable()
    message: CSRF protection is disabled. Enable CSRF protection for state-changing operations.
    severity: WARNING
    languages: [java]
    metadata:
      owasp: "A01:2021 - Broken Access Control"
      category: security

  # ========================================
  # Logging Sensitive Data
  # ========================================
  - id: logging-sensitive-data
    pattern-either:
      - pattern: log.info("... password: " + $PASSWORD + ...)
      - pattern: log.debug("... token: " + $TOKEN + ...)
      - pattern: log.error("... secret: " + $SECRET + ...)
    message: Sensitive data might be logged. Avoid logging passwords, tokens, or secrets.
    severity: WARNING
    languages: [java]
    metadata:
      cwe: "CWE-532: Information Exposure Through Log Files"
      owasp: "A09:2021 - Security Logging and Monitoring Failures"

  # ========================================
  # Open Redirect
  # ========================================
  - id: open-redirect
    pattern: |
      return "redirect:" + $URL;
    message: Possible open redirect vulnerability. Validate redirect URLs.
    severity: WARNING
    languages: [java]
    metadata:
      cwe: "CWE-601: URL Redirection to Untrusted Site"
      owasp: "A01:2021 - Broken Access Control"

  # ========================================
  # Unsafe Reflection
  # ========================================
  - id: unsafe-reflection
    pattern: |
      Class.forName($CLASSNAME)
    message: Unsafe reflection usage. Validate class names to prevent code injection.
    severity: WARNING
    languages: [java]
    metadata:
      cwe: "CWE-470: Use of Externally-Controlled Input to Select Classes or Code"
      category: security

  # ========================================
  # Spring Security Misconfigurations
  # ========================================
  - id: permitall-endpoints
    pattern: |
      .antMatchers(...).permitAll()
    message: Endpoint configured with permitAll(). Ensure this is intentional.
    severity: INFO
    languages: [java]
    metadata:
      category: security
      owasp: "A01:2021 - Broken Access Control"

  # ========================================
  # LDAP Injection
  # ========================================
  - id: ldap-injection
    pattern: |
      $LDAP.search($FILTER + $VAR, ...)
    message: Possible LDAP injection. Use parameterized searches.
    severity: ERROR
    languages: [java]
    metadata:
      cwe: "CWE-90: LDAP Injection"
      owasp: "A03:2021 - Injection"

  # ========================================
  # Best Practices
  # ========================================
  - id: use-parameterized-logging
    pattern: |
      log.$METHOD($MSG + $VAR)
    message: Use parameterized logging instead of string concatenation for better performance.
    severity: INFO
    languages: [java]
    metadata:
      category: best-practice

  - id: autocloseable-not-closed
    pattern: |
      $VAR = new $CLOSEABLE(...);
    message: AutoCloseable resource might not be closed. Use try-with-resources.
    severity: WARNING
    languages: [java]
    metadata:
      category: best-practice
      cwe: "CWE-772: Missing Release of Resource after Effective Lifetime"
